# Diagrama de Flujo Completo - ft_ping

Este diagrama muestra todo el proceso completo de tu proyecto ft_ping, desde el inicio hasta el final, incluyendo todos los m√≥dulos y funciones principales.

```mermaid
flowchart TB
    Start([INICIO: main]) --> CheckRoot{¬øPermisos root?}
    CheckRoot -->|No| ErrorRoot[Error: Requiere root]
    CheckRoot -->|S√≠| SetupSignal[Configurar se√±ales SIGINT/SIGALRM]
    ErrorRoot --> End1([FIN: Exit 1])
    
    SetupSignal --> ParseArgs[Parsear argumentos argc/argv]
    ParseArgs --> ValidateArgs{¬øArgumentos v√°lidos?}
    ValidateArgs -->|No| ShowHelp[Mostrar ayuda]
    ValidateArgs -->|S√≠| SetDefaults[Establecer valores por defecto]
    ShowHelp --> End2([FIN: Exit 0])
    
    SetDefaults --> ProcessFlags[Procesar flags:<br/>-v -c -f -s --ttl -i -W]
    ProcessFlags --> GetTarget[Extraer destino hostname/IP]
    GetTarget --> HasTarget{¬øTiene destino?}
    HasTarget -->|No| ErrorDest[Error: Destino requerido]
    ErrorDest --> End3([FIN: Exit 2])
    
    HasTarget -->|S√≠| SpecialIP{¬øIP decimal<br/>especial?}
    SpecialIP -->|S√≠| ConvertIP[Convertir formato IP<br/>192 ‚Üí 0.0.0.192]
    SpecialIP -->|No| ResolveHost[Resolver hostname]
    ConvertIP --> ResolveHost
    
    ResolveHost --> TryIP{¬øEs IP v√°lida?}
    TryIP -->|S√≠| UseIP[Usar IP directamente]
    TryIP -->|No| DNSLookup[getaddrinfo DNS lookup]
    DNSLookup --> DNSResult{¬øResuelto?}
    DNSResult -->|No| ErrorResolve[Error: No se pudo resolver]
    ErrorResolve --> End4([FIN: Exit 2])
    DNSResult -->|S√≠| UseIP
    
    UseIP --> CreateSocket[Crear socket RAW ICMP]
    CreateSocket --> SocketOK{¬øSocket OK?}
    SocketOK -->|No| ErrorSocket[Error: socket failed]
    ErrorSocket --> End5([FIN: Exit 1])
    
    SocketOK -->|S√≠| ConfigSocket[Configurar socket]
    ConfigSocket --> SetTimeout[setsockopt SO_RCVTIMEO<br/>timeout: 500ms]
    SetTimeout --> CheckTTL{¬øTTL personalizado?}
    CheckTTL -->|S√≠| SetTTL[setsockopt IP_TTL]
    CheckTTL -->|No| InitStats[Inicializar estad√≠sticas]
    SetTTL --> InitStats
    
    InitStats --> PrintBanner[Imprimir banner:<br/>PING target size bytes]
    PrintBanner --> SetupContext[Configurar contexto ping]
    SetupContext --> CheckCount{¬øL√≠mite -c?}
    CheckCount -->|S√≠| SetMax[max_packets = count]
    CheckCount -->|No| SetInfinite[max_packets = 0 infinito]
    SetMax --> LoopStart
    SetInfinite --> LoopStart
    
    LoopStart{Loop: ¬øContinuar?<br/>!g_stop && paquetes}
    LoopStart -->|No| ShowStats[Mostrar estad√≠sticas finales]
    LoopStart -->|S√≠| GetTime[gettimeofday send_time]
    
    GetTime --> BuildPacket[Construir paquete ICMP]
    BuildPacket --> SetHeader[type=8 code=0<br/>id=PID seq=counter]
    SetHeader --> FillData[Llenar payload:<br/>ft_ping payload data...]
    FillData --> CalcChecksum[Calcular checksum ICMP]
    CalcChecksum --> SendPacket[sendto paquete]
    SendPacket --> IncSent[packets_sent++]
    
    IncSent --> WaitReply[recvfrom esperar respuesta<br/>timeout 500ms]
    WaitReply --> GotReply{¬øRespuesta?}
    GotReply -->|Timeout| ShowTimeout[Imprimir Request timeout]
    GotReply -->|S√≠| GetRecvTime[gettimeofday recv_time]
    
    GetRecvTime --> ParseIP[Parsear IP header]
    ParseIP --> GetTTL[Extraer TTL del IP header]
    GetTTL --> SkipIP[Saltar IP header:<br/>buffer + ihl*4]
    SkipIP --> ParseICMP[Parsear ICMP header]
    
    ParseICMP --> CheckType{type del ICMP}
    CheckType -->|type=0 ECHOREPLY| ValidateID{¬øID coincide?}
    CheckType -->|type=3 Dest Unreach| ShowUnreach[Mostrar error:<br/>Host/Net Unreachable]
    CheckType -->|type=11 Time Exceed| ShowTTLExceed[Mostrar error:<br/>TTL exceeded]
    CheckType -->|type=5 Redirect| ShowRedirect[Mostrar Redirect]
    CheckType -->|Otro| IgnorePacket[Ignorar paquete]
    
    ShowUnreach --> ShowTimeout
    ShowTTLExceed --> ShowTimeout
    ShowRedirect --> ShowTimeout
    IgnorePacket --> WaitReply
    
    ValidateID -->|No coincide| IgnorePacket
    ValidateID -->|Coincide| CalcRTT[Calcular RTT:<br/>recv_time - send_time]
    CalcRTT --> IncRecv[packets_received++]
    IncRecv --> UpdateStats[Actualizar min/max/avg/mdev]
    UpdateStats --> PrintReply[Imprimir respuesta:<br/>bytes from IP seq ttl time]
    
    PrintReply --> CheckStop{¬øg_stop?}
    ShowTimeout --> CheckStop
    CheckStop -->|S√≠| ShowStats
    CheckStop -->|No| IncSeq[sequence++]
    
    IncSeq --> CheckFlood{¬øModo flood -f?}
    CheckFlood -->|S√≠| LoopStart
    CheckFlood -->|No| CheckInterval{¬øIntervalo -i?}
    CheckInterval -->|>= 1s| SleepSec[sleep segundos]
    CheckInterval -->|< 1s| SleepMicro[usleep microsegundos]
    SleepSec --> LoopStart
    SleepMicro --> LoopStart
    
    ShowStats --> CalcLoss[Calcular p√©rdida:<br/>packets_sent - packets_received]
    CalcLoss --> CalcPercent[Porcentaje p√©rdida]
    CalcPercent --> CalcTime[Calcular tiempo total]
    CalcTime --> PrintSummary[Imprimir:<br/>X transmitted Y received Z% loss]
    PrintSummary --> HasReceived{¬øRecibidos > 0?}
    HasReceived -->|S√≠| PrintRTT[Imprimir:<br/>rtt min/avg/max/mdev]
    HasReceived -->|No| CloseSocket
    PrintRTT --> CloseSocket[close socket]
    CloseSocket --> Cleanup[Liberar memoria args]
    Cleanup --> End([FIN: Exit 0])
    
    style Start fill:#2d5f7f,stroke:#5da9e9,stroke-width:3px,color:#fff
    style End fill:#2d7f2d,stroke:#5de95d,stroke-width:3px,color:#fff
    style End1 fill:#7f2d2d,stroke:#e95d5d,stroke-width:2px,color:#fff
    style End2 fill:#7f2d2d,stroke:#e95d5d,stroke-width:2px,color:#fff
    style End3 fill:#7f2d2d,stroke:#e95d5d,stroke-width:2px,color:#fff
    style End4 fill:#7f2d2d,stroke:#e95d5d,stroke-width:2px,color:#fff
    style End5 fill:#7f2d2d,stroke:#e95d5d,stroke-width:2px,color:#fff
    style CheckRoot fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style ValidateArgs fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style HasTarget fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style TryIP fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style DNSResult fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style SocketOK fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style CheckTTL fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style CheckCount fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style LoopStart fill:#5f3d7f,stroke:#a97de9,stroke-width:3px,color:#fff
    style GotReply fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style CheckType fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style ValidateID fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style CheckStop fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style CheckFlood fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style CheckInterval fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style HasReceived fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
    style SpecialIP fill:#7f6d2d,stroke:#e9c95d,stroke-width:2px,color:#fff
```

## üìã Descripci√≥n de las Fases

### 1Ô∏è‚É£ **Fase de Inicializaci√≥n**
- Verificaci√≥n de permisos root (requerido para RAW socket)
- Configuraci√≥n de se√±ales (SIGINT para Ctrl+C)
- Parseo y validaci√≥n de argumentos

### 2Ô∏è‚É£ **Fase de Configuraci√≥n**
- Procesamiento de flags: `-v`, `-c`, `-f`, `-s`, `--ttl`, `-i`, `-W`
- Extracci√≥n del destino (hostname o IP)
- Resoluci√≥n DNS con `getaddrinfo()`
- Manejo de IPs decimales especiales

### 3Ô∏è‚É£ **Fase de Preparaci√≥n de Red**
- Creaci√≥n del socket RAW ICMP
- Configuraci√≥n de timeout (500ms)
- Configuraci√≥n opcional de TTL
- Inicializaci√≥n de estructuras de estad√≠sticas

### 4Ô∏è‚É£ **Fase de Loop Principal**
- Construcci√≥n del paquete ICMP Echo Request
- C√°lculo del checksum
- Env√≠o con `sendto()`
- Espera de respuesta con `recvfrom()`
- Manejo de diferentes tipos de respuesta ICMP

### 5Ô∏è‚É£ **Fase de Procesamiento de Respuesta**
- Parseo del header IP (para extraer TTL)
- Parseo del header ICMP
- Validaci√≥n de tipo y ID
- C√°lculo del RTT (Round Trip Time)
- Actualizaci√≥n de estad√≠sticas

### 6Ô∏è‚É£ **Fase de Control de Flujo**
- Verificaci√≥n de se√±al de parada (Ctrl+C)
- Control de n√∫mero de paquetes (`-c`)
- Gesti√≥n de intervalo entre paquetes (`-i`)
- Modo flood sin delays (`-f`)

### 7Ô∏è‚É£ **Fase de Finalizaci√≥n**
- C√°lculo de estad√≠sticas finales
- C√°lculo de porcentaje de p√©rdida
- Impresi√≥n de resumen (min/avg/max/mdev)
- Cierre de socket y limpieza de memoria

## üîë Funciones Clave por Archivo

| Archivo | Funciones Principales |
|---------|----------------------|
| `ft_ping.c` | `main()`, `setup_handler()`, `start_ping_loop()` |
| `parse_args.c` | `parse_arguments()`, `check_all_flags()`, `get_target_from_args()` |
| `resolver.c` | `find_target_address()`, `check_if_ip()`, `find_hostname_ip()` |
| `socket.c` | `create_socket()`, `set_socket_ttl()`, `close_socket()` |
| `icmp_send.c` | `icmp_request()` |
| `icmp_recv.c` | `icmp_receive()` |
| `icmp_utils.c` | `icmp_checksum()` |
| `stats.c` | `setup_stats()`, `count_sent_packet()`, `count_got_packet()`, `print_final_stats()` |
| `signal.c` | `setup_signal_handler()`, `signal_handler()` |

## üìä Estructuras de Datos

### `t_args`
Almacena todos los argumentos parseados:
- `target`: destino (hostname o IP)
- `packet_count`: n√∫mero de paquetes (`-c`)
- `packet_bytes`: tama√±o del payload (`-s`)
- `time_to_live`: TTL (`--ttl`)
- `mode_verbose`: salida detallada (`-v`)
- `flood_mode`: modo flood (`-f`)
- `interval`: intervalo entre paquetes (`-i`)
- `timeout`: timeout de respuesta (`-W`)

### `t_ping_stats`
Almacena estad√≠sticas de ejecuci√≥n:
- `packets_sent`: paquetes transmitidos
- `packets_got`: paquetes recibidos
- `fastest_time`: RTT m√≠nimo
- `slowest_time`: RTT m√°ximo
- `total_time`: suma de RTTs
- `total_time_squared`: suma de RTTs¬≤ (para mdev)
- `start_moment`, `end_moment`: timestamps

### `t_ping_context`
Contexto de ejecuci√≥n:
- `socket_fd`: descriptor del socket
- `target_addr`: direcci√≥n destino
- `packet_id`: ID del paquete (PID)
- `packet_number`: n√∫mero de secuencia
- `stats`: puntero a estad√≠sticas
- `args`: puntero a argumentos

## üåê Protocolo ICMP

### Paquete ICMP Echo Request (enviado)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Type (8) ‚îÇ Code (0) ‚îÇ Checksum ‚îÇ          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ        ID (PID)      ‚îÇ   Sequence Number   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚î§
‚îÇ              Payload Data                  ‚îÇ
‚îÇ       ("ft_ping payload data...")          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Paquete ICMP Echo Reply (recibido)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         IP Header (20 bytes)             ‚îÇ
‚îÇ  - TTL (usado para mostrar)              ‚îÇ
‚îÇ  - Source IP                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Type (0) ‚îÇ Code (0) ‚îÇ Checksum ‚îÇ        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ        ID (PID)      ‚îÇ   Sequence       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Payload Data (echo)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üö® Tipos de Error ICMP Manejados

| Type | Code | Nombre | Manejo |
|------|------|--------|--------|
| 0 | 0 | Echo Reply | ‚úÖ Procesar RTT y mostrar |
| 3 | 0-5 | Destination Unreachable | ‚ö†Ô∏è Mostrar error espec√≠fico |
| 5 | 0-3 | Redirect | ‚ö†Ô∏è Mostrar redirect |
| 11 | 0 | Time Exceeded (TTL) | ‚ö†Ô∏è Mostrar TTL exceeded |
| 12 | 0 | Parameter Problem | ‚ö†Ô∏è Mostrar error de par√°metro |

## üìà C√°lculos Estad√≠sticos

### RTT (Round Trip Time)
```
RTT = (recv_time.tv_sec - send_time.tv_sec) * 1000.0 +
      (recv_time.tv_usec - send_time.tv_usec) / 1000.0
```

### P√©rdida de Paquetes
```
packet_loss = ((packets_sent - packets_got) / packets_sent) * 100.0
```

### Promedio RTT
```
avg_rtt = total_time / packets_got
```

### Desviaci√≥n Est√°ndar (mdev)
```
variance = (total_time_squared / packets_got) - (avg_rtt * avg_rtt)
mdev = sqrt(variance)
```

## üéØ Casos de Uso

### Uso B√°sico
```bash
sudo ./ft_ping google.com
```

### Con Opciones
```bash
# Verbose + l√≠mite de paquetes
sudo ./ft_ping -v -c 5 8.8.8.8

# Tama√±o personalizado + intervalo
sudo ./ft_ping -s 1000 -i 0.5 google.com

# Modo flood + TTL personalizado
sudo ./ft_ping -f --ttl 64 -c 100 8.8.8.8

# Timeout personalizado
sudo ./ft_ping -W 5 -c 3 example.com
```


